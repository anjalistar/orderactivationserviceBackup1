<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Get_Add_On_Only_Prices</name>
        <label>Get Add On Only Prices</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <actionName>ExecuteSOQL</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>loop_PB_Priced_Lines</targetReference>
        </connector>
        <dataTypeMappings>
            <typeName>U__sObjects</typeName>
            <typeValue>AddOn_Pricebook__c</typeValue>
        </dataTypeMappings>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>soqlQuery</name>
            <value>
                <elementReference>calcAddOnOnlySOQL</elementReference>
            </value>
        </inputParameters>
        <nameSegment>ExecuteSOQL</nameSegment>
        <offset>0</offset>
        <outputParameters>
            <assignToReference>collAddOnPricebooks</assignToReference>
            <name>sObjects</name>
        </outputParameters>
    </actionCalls>
    <actionCalls>
        <name>Get_New_Sales_Add_On_Prices</name>
        <label>Get New Sales Add-On Prices</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <actionName>ExecuteSOQL</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>loop_PB_Priced_Lines</targetReference>
        </connector>
        <dataTypeMappings>
            <typeName>U__sObjects</typeName>
            <typeValue>AddOn_Pricebook__c</typeValue>
        </dataTypeMappings>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>soqlQuery</name>
            <value>
                <elementReference>calcAddOnPriceSOQL</elementReference>
            </value>
        </inputParameters>
        <nameSegment>ExecuteSOQL</nameSegment>
        <offset>0</offset>
        <outputParameters>
            <assignToReference>collAddOnPricebooks</assignToReference>
            <name>sObjects</name>
        </outputParameters>
    </actionCalls>
    <actionCalls>
        <name>Get_Non_AddOn_Price_Book_Lines</name>
        <label>Get Non AddOn Price Book Lines</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <actionName>ExecuteSOQL</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Add_On_Opportunity</targetReference>
        </connector>
        <dataTypeMappings>
            <typeName>U__sObjects</typeName>
            <typeValue>Price_Book_Line__c</typeValue>
        </dataTypeMappings>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>soqlQuery</name>
            <value>
                <elementReference>calcPriceBookLineSOQL</elementReference>
            </value>
        </inputParameters>
        <nameSegment>ExecuteSOQL</nameSegment>
        <offset>0</offset>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <apiVersion>57.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>asgn_Add_On_Plan_Id</name>
        <label>asgn Add-On Plan Id</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>collPricePlanIds</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>loop_Add_On_Prices.Price_Plan__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>loop_Add_On_Prices</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_AddOn_USD_Line_Item_Price</name>
        <label>asgn AddOn USD Line Item Price</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>varOppUSDTotalPrice</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>varLineItemUSDPrice</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>asgn_Blank_AddOn_Prices</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Blank_AddOn_Prices</name>
        <label>asgn Blank AddOn Prices</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>collFilteredAddOnPrices</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>collBlankAddOnPrices</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>loop_Filtered_AddOn_Prices</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Filter_AddOn_Prices</name>
        <label>asgn Filter AddOn Prices</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>collFilteredAddOnPrices</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Filter_Add_On_Prices</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>loop_Filtered_AddOn_Prices</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Filtered_Add_On_Tiers</name>
        <label>asgn Filtered Add On Tiers</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>collFilteredAddOnTiers</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Filter_AddOn_Tiers</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_AddOn_Line_Price</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Filtered_Non_Add_On_Tiers_for_loop</name>
        <label>asgn Filtered Non Add On Tiers for loop</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>collFilteredNonAddOnTiers</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Filter_Tiers</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_Line_Price</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Found_Tiers</name>
        <label>asgn Found Tiers</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>collFoundTiers</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Price_Tiers2</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>collTiersForLoop</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Price_Tiers2</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>loop_Non_Add_On_Opp_Line</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Opp_Line_Qty</name>
        <label>asgn Opp Line Qty</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>varOppAddOnLinePricePlan</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>loop_Filtered_AddOn_Prices.Price_Plan__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Filter_AddOn_Tiers</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Opp_Rec</name>
        <label>asgn Opp Rec</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>OppRec_In</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_Opp_Rec</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_Priced_Non_AddOn_Opp_Lines</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_OppLineProduct</name>
        <label>asgn OppLineProduct</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>varOppLineProd</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>loop_Non_Add_On_Opp_Line.Product2Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varOppLineQty</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>loop_Non_Add_On_Opp_Line.Quantity</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Filter_PB_Lines_for_No_Add_On_Product</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_OppProduct</name>
        <label>asgn OppProduct</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>varOppLineProd</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>loop_Priced_Add_Ons.Product2Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>varOppLineQty</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>loop_Priced_Add_Ons.Quantity</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Filter_AddOn_Pricebooks</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_Plan_Id</name>
        <label>asgn Plan Id</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>collPricePlanIds</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>loop_PB_Priced_Lines.WPE_Price_Plan__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>loop_PB_Priced_Lines</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>asgn_USD_Line_Item_Price</name>
        <label>asgn USD Line Item Price</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignmentItems>
            <assignToReference>varOppUSDTotalPrice</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>varLineItemUSDPrice</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>loop_Filtered_PB_Lines</targetReference>
        </connector>
    </assignments>
    <collectionProcessors>
        <name>Filter_Add_On_Prices</name>
        <elementSubtype>FilterCollectionProcessor</elementSubtype>
        <label>Filter Add-On Prices</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNextValueToReference>currentItem_Filter_Add_On_Prices</assignNextValueToReference>
        <collectionProcessorType>FilterCollectionProcessor</collectionProcessorType>
        <collectionReference>collAddOnPricebooks</collectionReference>
        <conditionLogic>and</conditionLogic>
        <conditions>
            <leftValueReference>currentItem_Filter_Add_On_Prices.ProductItem__c</leftValueReference>
            <operator>EqualTo</operator>
            <rightValue>
                <elementReference>varOppLineProd</elementReference>
            </rightValue>
        </conditions>
        <connector>
            <targetReference>asgn_Filter_AddOn_Prices</targetReference>
        </connector>
    </collectionProcessors>
    <collectionProcessors>
        <name>Filter_AddOn_Pricebooks</name>
        <elementSubtype>FilterCollectionProcessor</elementSubtype>
        <label>Filter AddOn Pricebooks</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNextValueToReference>currentItem_Filter_AddOn_Pricebooks</assignNextValueToReference>
        <collectionProcessorType>FilterCollectionProcessor</collectionProcessorType>
        <collectionReference>collAddOnPricebooks</collectionReference>
        <conditionLogic>and</conditionLogic>
        <conditions>
            <leftValueReference>currentItem_Filter_AddOn_Pricebooks.ProductItem__c</leftValueReference>
            <operator>EqualTo</operator>
            <rightValue>
                <elementReference>varOppLineProd</elementReference>
            </rightValue>
        </conditions>
        <connector>
            <targetReference>Filter_Add_On_Prices</targetReference>
        </connector>
    </collectionProcessors>
    <collectionProcessors>
        <name>Filter_AddOn_Tiers</name>
        <elementSubtype>FilterCollectionProcessor</elementSubtype>
        <label>Filter AddOn Tiers</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNextValueToReference>currentItem_Filter_AddOn_Tiers</assignNextValueToReference>
        <collectionProcessorType>FilterCollectionProcessor</collectionProcessorType>
        <collectionReference>collFoundTiers</collectionReference>
        <conditionLogic>and</conditionLogic>
        <conditions>
            <leftValueReference>currentItem_Filter_AddOn_Tiers.Price_Plan__c</leftValueReference>
            <operator>EqualTo</operator>
            <rightValue>
                <elementReference>varOppAddOnLinePricePlan</elementReference>
            </rightValue>
        </conditions>
        <conditions>
            <leftValueReference>currentItem_Filter_AddOn_Tiers.Above_From_Quantity__c</leftValueReference>
            <operator>LessThan</operator>
            <rightValue>
                <elementReference>loop_Priced_Add_Ons.Quantity</elementReference>
            </rightValue>
        </conditions>
        <connector>
            <targetReference>asgn_Filtered_Add_On_Tiers</targetReference>
        </connector>
    </collectionProcessors>
    <collectionProcessors>
        <name>Filter_PB_Lines_for_No_Add_On_Product</name>
        <elementSubtype>FilterCollectionProcessor</elementSubtype>
        <label>Filter PB Lines for No Add-On Product</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNextValueToReference>currentItem_Filter_PB_Lines_for_No_Add_On_Product</assignNextValueToReference>
        <collectionProcessorType>FilterCollectionProcessor</collectionProcessorType>
        <collectionReference>Get_Non_AddOn_Price_Book_Lines.sObjects</collectionReference>
        <conditionLogic>and</conditionLogic>
        <conditions>
            <leftValueReference>currentItem_Filter_PB_Lines_for_No_Add_On_Product.Product__c</leftValueReference>
            <operator>EqualTo</operator>
            <rightValue>
                <elementReference>varOppLineProd</elementReference>
            </rightValue>
        </conditions>
        <connector>
            <targetReference>loop_Filtered_PB_Lines</targetReference>
        </connector>
    </collectionProcessors>
    <collectionProcessors>
        <name>Filter_Tiers</name>
        <elementSubtype>FilterCollectionProcessor</elementSubtype>
        <label>Filter Tiers</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNextValueToReference>currentItem_Filter_Tiers_0</assignNextValueToReference>
        <collectionProcessorType>FilterCollectionProcessor</collectionProcessorType>
        <collectionReference>collFoundTiers</collectionReference>
        <conditionLogic>and</conditionLogic>
        <conditions>
            <leftValueReference>currentItem_Filter_Tiers_0.Above_From_Quantity__c</leftValueReference>
            <operator>LessThan</operator>
            <rightValue>
                <elementReference>loop_Non_Add_On_Opp_Line.Quantity</elementReference>
            </rightValue>
        </conditions>
        <conditions>
            <leftValueReference>currentItem_Filter_Tiers_0.Price_Plan__c</leftValueReference>
            <operator>EqualTo</operator>
            <rightValue>
                <elementReference>loop_Filtered_PB_Lines.WPE_Price_Plan__c</elementReference>
            </rightValue>
        </conditions>
        <connector>
            <targetReference>asgn_Filtered_Non_Add_On_Tiers_for_loop</targetReference>
        </connector>
    </collectionProcessors>
    <decisions>
        <name>Add_On_Opportunity</name>
        <label>Add-On Opportunity</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <defaultConnector>
            <targetReference>Get_New_Sales_Add_On_Prices</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Opportunity_is_Add_On</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>OppRec_In.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Add_On</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Add_On_Only_Prices</targetReference>
            </connector>
            <label>Opportunity is Add-On</label>
        </rules>
    </decisions>
    <decisions>
        <name>dcn_Amount_0</name>
        <label>dcn Amount &gt; 0</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Opp_has_amount</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Amount</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Opp_Rec</targetReference>
            </connector>
            <label>Opp has amount</label>
        </rules>
    </decisions>
    <decisions>
        <name>dcn_Price_Plans_Available</name>
        <label>dcn Price Plans Available</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <defaultConnector>
            <targetReference>Update_Opp_USD_Price</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Price_Plans_Found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>collPricePlanIds</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Price_Tiers2</targetReference>
            </connector>
            <label>Price Plans Found</label>
        </rules>
    </decisions>
    <decisions>
        <name>dcn_Tiers_Found</name>
        <label>dcn Tiers Found</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <defaultConnector>
            <targetReference>Update_Opp_USD_Price</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Tiers_Available</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Price_Tiers2</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>asgn_Found_Tiers</targetReference>
            </connector>
            <label>Tiers Available</label>
        </rules>
    </decisions>
    <description>10Apr25 - PAT | ESS-1910| Added PriceBookNetSuiteDataCenter_Add_On in the calcAddOnPriceSOQL SOQL Query
31Mar25 - Add Subscription Plan in the where clause of calcAddOnOnlySOQL soqlQuery
07Feb25 - ESS(DON) Pulls the last four characters from the selected Price Book NetSuite to use when querying for the USD Price Book. Will return -base, -ger, -twnjp, -sgaus, -cad or -gerukire
24May23 - CC(SDA) add check in AddOnOnly SOQL for BAPI Backed to get the Subscription Plan from Opp instead of linked Sub
04May23 - CC(SDA) Call new calc tier price subflow</description>
    <environments>Default</environments>
    <formulas>
        <name>calcAddOnLineUSDPRice</name>
        <dataType>Number</dataType>
        <expression>({!loop_Priced_Add_Ons.Quantity} * {!varAddOnTierValue})</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>calcAddOnOnlySOQL</name>
        <dataType>String</dataType>
        <expression>&quot;Select Id,Name, Price_Plan__c, ProductCode__c, ProductItem__c, Recurrence__c, Subscription_plan__c, CurrencyIsoCode, CreatedDate FROM AddOn_Pricebook__c WHERE ProductItem__c IN (Select PRoduct2Id from OpportunityLineItem WHERE OpportunityId = &apos;&quot; +{!OppRec_In.Id} + &quot;&apos; AND TotalPrice &gt; 0) AND Recurrence__c = &apos;Monthly&apos; AND Subscription_Plan__c = &apos;&quot; + {!OppRec_In.WPE_Subscription_plan__c} + IF(TEXT({!OppRec_In.Subscription__r.Source__c})=&apos;BAPI&apos;, {!OppRec_In.WPE_Subscription_plan__c},{!OppRec_In.Subscription__r.Subscription_plan__c}) + &quot;&apos; AND CurrencyIsoCode = &apos;USD&apos;&quot;</expression>
    </formulas>
    <formulas>
        <name>calcAddOnPriceSOQL</name>
        <dataType>String</dataType>
        <expression>&quot;Select Id,Name, Price_Plan__c, ProductCode__c, ProductItem__c, Recurrence__c, Subscription_plan__c, CurrencyIsoCode, CreatedDate FROM AddOn_Pricebook__c WHERE ProductItem__c IN (Select PRoduct2Id from OpportunityLineItem WHERE OpportunityId = &apos;&quot; +{!OppRec_In.Id} + &quot;&apos; AND TotalPrice &gt; 0) AND Recurrence__c = &apos;Monthly&apos; AND Subscription_Plan__c = &apos;&quot; + {!OppRec_In.WPE_Subscription_plan__c} + &quot;&apos; AND CurrencyIsoCode = &apos;USD&apos; AND Region__c = &apos;&quot; + {!PriceBookNetSuiteDataCenter_Add_On} + &quot;&apos;&quot;</expression>
    </formulas>
    <formulas>
        <name>calcOppUSDGross</name>
        <dataType>Number</dataType>
        <expression>IF(ISPICKVAL({!$Record.WPE_Price_book_NetSuite__r.Price_Book_Term__c},&quot;Annually&quot;),{!varOppUSDTotalPrice}/0.92,{!varOppUSDTotalPrice})</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>calcPriceBookLineSOQL</name>
        <dataType>String</dataType>
        <expression>&quot;select Id, WPE_Price_Plan__c,Product__c FROM Price_Book_Line__c where Price_book_NetSuite__c = &apos;&quot; + {!Get_USD_Pricebook.Id} + &quot;&apos; AND Product__c IN (Select Product2Id FROM OpportunityLineItem WHERE OpportunityId = &apos;&quot; + {!OppRec_In.Id} + &quot;&apos; AND TotalPRice &gt; 0) AND Price_book_NetSuite__r.Price_Book_Term__c = &apos;Monthly&apos; AND Price_book_NetSuite__r.Subscription_Plan__c = &apos;&quot; + {!OppRec_In.WPE_Subscription_plan__c} + &quot;&apos; AND CurrencyIsoCode = &apos;USD&apos;&quot;</expression>
    </formulas>
    <formulas>
        <name>calcPriceTierSOQL</name>
        <dataType>String</dataType>
        <expression>&quot;select Id,Above_From_Quantity__c, Maximum_Amount__c, Minimum_Account__c, Name, PriceBookId__c, Pricing_Option__c, Value__c from Price_Tier__c where Price_Plan__c IN (&quot; + {!varPricePlanIds} + &quot;)&quot;</expression>
    </formulas>
    <formulas>
        <description>Pulls the last four characters from the selected Price Book NetSuite to use when querying for the USD Price Book. Will return -base, -ger, -twnjp, -sgaus, -cad or -gerukire</description>
        <name>PriceBookNetSuiteDataCenter</name>
        <dataType>String</dataType>
        <expression>MID( {!$Record.WPE_Price_book_NetSuite__r.Name}, 
FIND( &quot;-&quot;, {!$Record.WPE_Price_book_NetSuite__r.Name}, 
FIND( &quot;-&quot;, {!$Record.WPE_Price_book_NetSuite__r.Name} ) + 1 ),
    LEN( {!$Record.WPE_Price_book_NetSuite__r.Name} )
)</expression>
    </formulas>
    <formulas>
        <description>Used to pull the Data Center of the Price Book linked to the Opportunity. Possible values: base, ger, cad, gerukire, sgaus, twnjp.</description>
        <name>PriceBookNetSuiteDataCenter_Add_On</name>
        <dataType>String</dataType>
        <expression>RIGHT({!$Record.WPE_Price_book_NetSuite__r.Name},(LEN( {!$Record.WPE_Price_book_NetSuite__r.Name})-FIND(&quot;-&quot;, {!$Record.WPE_Price_book_NetSuite__r.Name},FIND(&quot;-&quot;, {!$Record.WPE_Price_book_NetSuite__r.Name})+1)))</expression>
    </formulas>
    <interviewLabel>Get USD - record triggered {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Get Opportunity Current USD Price</label>
    <loops>
        <name>loop_Add_On_Prices</name>
        <label>loop Add-On Prices</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <collectionReference>collAddOnPricebooks</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>asgn_Add_On_Plan_Id</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>dcn_Price_Plans_Available</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>loop_Filtered_AddOn_Prices</name>
        <label>loop Filtered AddOn Prices</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <collectionReference>collFilteredAddOnPrices</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>asgn_Opp_Line_Qty</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>loop_Priced_Add_Ons</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>loop_Filtered_PB_Lines</name>
        <label>loop Filtered PB Lines</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <collectionReference>Filter_PB_Lines_for_No_Add_On_Product</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Filter_Tiers</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>loop_Non_Add_On_Opp_Line</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>loop_Non_Add_On_Opp_Line</name>
        <label>loop Non_Add_On_Opp_Line</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <collectionReference>Get_Priced_Non_AddOn_Opp_Lines</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>asgn_OppLineProduct</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>loop_Priced_Add_Ons</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>loop_PB_Priced_Lines</name>
        <label>loop PB Priced Lines</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <collectionReference>Get_Non_AddOn_Price_Book_Lines.sObjects</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>asgn_Plan_Id</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>loop_Add_On_Prices</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>loop_Priced_Add_Ons</name>
        <label>loop Priced Add-Ons</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <collectionReference>Get_Priced_AddOn_Opp_Lines</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>asgn_OppProduct</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_Opp_USD_Price</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Opp_Rec</name>
        <label>Get Opp Rec</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>asgn_Opp_Rec</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Opportunity</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Price_Tiers2</name>
        <label>Get Price Tiers2</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>dcn_Tiers_Found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Price_Plan__c</field>
            <operator>In</operator>
            <value>
                <elementReference>collPricePlanIds</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Price_Tier__c</object>
        <sortField>Above_From_Quantity__c</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Priced_AddOn_Opp_Lines</name>
        <label>Get Priced AddOn Opp Lines</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_USD_Pricebook</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OpportunityId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>OppRec_In.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>TotalPrice</field>
            <operator>GreaterThan</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </filters>
        <filters>
            <field>Catalog_Type__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Add-On</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>OpportunityLineItem</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Priced_Non_AddOn_Opp_Lines</name>
        <label>Get Priced Non-AddOn Opp Lines</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Priced_AddOn_Opp_Lines</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OpportunityId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>OppRec_In.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>TotalPrice</field>
            <operator>GreaterThan</operator>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </filters>
        <filters>
            <field>Catalog_Type__c</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>Add-On</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>OpportunityLineItem</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_USD_Pricebook</name>
        <label>Get USD Pricebook</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Non_AddOn_Price_Book_Lines</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>CurrencyIsoCode</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>USD</stringValue>
            </value>
        </filters>
        <filters>
            <field>Price_Book_Term__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Monthly</stringValue>
            </value>
        </filters>
        <filters>
            <field>Subscription_plan__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>OppRec_In.WPE_Subscription_plan__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>Contains</operator>
            <value>
                <elementReference>PriceBookNetSuiteDataCenter</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Price_books_NetSuite__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Opp_USD_Price</name>
        <label>Update Opp USD Price</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <inputAssignments>
            <field>Opportunity_USD_Price__c</field>
            <value>
                <elementReference>varOppUSDTotalPrice</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <filterLogic>or</filterLogic>
        <filters>
            <field>Amount</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>Opportunity</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <scheduledPaths>
            <connector>
                <targetReference>dcn_Amount_0</targetReference>
            </connector>
            <pathType>AsyncAfterCommit</pathType>
        </scheduledPaths>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <name>Get_AddOn_Line_Price</name>
        <label>Get AddOn Line Price</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>asgn_AddOn_USD_Line_Item_Price</targetReference>
        </connector>
        <flowName>Calculate_Tier_Price_for_Subscription_Lines</flowName>
        <inputAssignments>
            <name>colPriceTierRecords</name>
            <value>
                <elementReference>collFilteredAddOnTiers</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>NumQuantity</name>
            <value>
                <elementReference>varOppLineQty</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>txtPricePlanId</name>
            <value>
                <elementReference>varOppAddOnLinePricePlan</elementReference>
            </value>
        </inputAssignments>
        <outputAssignments>
            <assignToReference>varLineItemUSDPrice</assignToReference>
            <name>CurrOutputPriceValue</name>
        </outputAssignments>
    </subflows>
    <subflows>
        <description>Use the new subflow to get the Tier price for the line</description>
        <name>Get_Line_Price</name>
        <label>Get Line Price</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>asgn_USD_Line_Item_Price</targetReference>
        </connector>
        <flowName>Calculate_Tier_Price_for_Subscription_Lines</flowName>
        <inputAssignments>
            <name>colPriceTierRecords</name>
            <value>
                <elementReference>collFilteredNonAddOnTiers</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>NumQuantity</name>
            <value>
                <elementReference>varOppLineQty</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>txtPricePlanId</name>
            <value>
                <elementReference>collPricedPlanIds.Id</elementReference>
            </value>
        </inputAssignments>
        <outputAssignments>
            <assignToReference>varLineItemUSDPrice</assignToReference>
            <name>CurrOutputPriceValue</name>
        </outputAssignments>
    </subflows>
    <triggerOrder>1930</triggerOrder>
    <variables>
        <name>collAddOnPricebooks</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>AddOn_Pricebook__c</objectType>
    </variables>
    <variables>
        <name>collBlankAddOnPrices</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>AddOn_Pricebook__c</objectType>
    </variables>
    <variables>
        <name>collBlankTiers</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>collFilteredAddOnPrices</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>AddOn_Pricebook__c</objectType>
    </variables>
    <variables>
        <name>collFilteredAddOnTiers</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>collFilteredNonAddOnTiers</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>collFoundTiers</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>collPricedPlanIds</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Plan__c</objectType>
    </variables>
    <variables>
        <name>collPriceLines</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Plan__c</objectType>
    </variables>
    <variables>
        <name>collPricePlanIds</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>collTiersForLoop</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>currentItem_Filter_Add_On_Prices</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>AddOn_Pricebook__c</objectType>
    </variables>
    <variables>
        <name>currentItem_Filter_AddOn_Pricebooks</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>AddOn_Pricebook__c</objectType>
    </variables>
    <variables>
        <name>currentItem_Filter_AddOn_Prices</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>AddOn_Pricebook__c</objectType>
    </variables>
    <variables>
        <name>currentItem_Filter_AddOn_Tiers</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>currentItem_filter_Non_AddOns</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Book_Line__c</objectType>
    </variables>
    <variables>
        <name>currentItem_Filter_PB_Lines_for_No_Add_On_Product</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Book_Line__c</objectType>
    </variables>
    <variables>
        <name>currentItem_Filter_Tiers</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>currentItem_Filter_Tiers_0</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>currentItemFromSourceCollection</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Plan__c</objectType>
    </variables>
    <variables>
        <name>currentItemFromSourceCollection_0</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Price_Tier__c</objectType>
    </variables>
    <variables>
        <name>currentItemFromSourceCollection_0_0</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>AddOn_Pricebook__c</objectType>
    </variables>
    <variables>
        <name>OppRec_In</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>varAddOnTierValue</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>varLineItemUSDPrice</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>varOppAddOnLinePricePlan</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>varOppAddOnLineQty</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>varOppLineProd</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>varOppLineQty</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>varOppUSDTotalPrice</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>varPricePlanIds</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
